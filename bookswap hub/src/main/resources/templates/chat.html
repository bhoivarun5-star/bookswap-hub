<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="'Chat â€“ ' + ${req.book.title} + ' â€“ BookSwap Hub'">Chat</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/books.css}" />
    <script th:src="@{/js/theme.js}"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body class="chat-body">

    <!-- â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <header class="chat-topbar">
        <a class="chat-back-link" th:href="@{/my-requests}">â† Back</a>

        <div class="chat-header-info">
            <div class="chat-avatar" th:text="${#strings.substring(otherUser.username, 0, 1).toUpperCase()}">U</div>
            <div>
                <div class="chat-header-name" th:text="${otherUser.username}">Username</div>
                <div class="chat-header-sub">
                    ğŸ“š <span th:text="${req.book.title}">Book</span>
                    &nbsp;Â·&nbsp;
                    â‚¹<span th:text="${req.book.price}">0</span>
                </div>
            </div>
        </div>

        <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">â˜€ï¸</button>
    </header>

    <!-- â”€â”€ Message List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <main class="chat-messages" id="chatMessages">

        <div class="chat-date-chip">
            <span>Conversation started Â· <span th:text="${#temporals.format(req.createdAt, 'dd MMM yyyy')}"></span></span>
        </div>

        <!-- Existing messages (server-rendered) -->
        <th:block th:each="msg : ${messages}">
            <div th:classappend="${msg.sender.username == currentUser.username} ? ' own' : ' other'"
                 class="chat-bubble-row">
                <div th:unless="${msg.sender.username == currentUser.username}"
                     class="chat-bubble-avatar"
                     th:text="${#strings.substring(msg.sender.username, 0, 1).toUpperCase()}">U</div>
                <div class="chat-bubble">
                    <div th:unless="${msg.sender.username == currentUser.username}"
                         class="chat-bubble-sender"
                         th:text="${msg.sender.username}">Sender</div>
                    <!-- check if message is a location link -->
                    <th:block th:if="${#strings.startsWith(msg.content, 'ğŸ“')}">
                        <span th:text="${'ğŸ“ Shared a location â†’ '}"></span>
                        <a th:href="${#strings.substringAfter(msg.content, 'â†’ ')}"
                           target="_blank" rel="noopener" class="chat-location-link"
                           th:text="${'Open in Maps'}">Open in Maps</a>
                    </th:block>
                    <th:block th:unless="${#strings.startsWith(msg.content, 'ğŸ“')}">
                        <span th:text="${msg.content}"></span>
                    </th:block>
                    <div class="chat-bubble-time"
                         th:text="${#temporals.format(msg.sentAt, 'hh:mm a')}">00:00</div>
                </div>
            </div>
        </th:block>
    </main>

    <!-- â”€â”€ Input Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <footer class="chat-inputbar">
        <button type="button" class="chat-loc-btn" onclick="shareLocation()" title="Share your location">ğŸ“</button>
        <form id="chatForm" onsubmit="return false;" style="flex:1;display:flex;gap:0.4rem;min-width:0;">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type a messageâ€¦"
                   maxlength="1000" autocomplete="off" inputmode="text" enterkeyhint="send" />
            <button type="submit" class="chat-send-btn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"
                     stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </form>
    </footer>

    <script th:inline="javascript">
        const REQUEST_ID  = /*[[${req.id}]]*/ 0;
        const CURRENT_USER = /*[[${currentUser.username}]]*/ '';
        const OTHER_USER   = /*[[${otherUser.username}]]*/ '';
        let lastMsgId = /*[[${messages.isEmpty() ? 0 : messages[messages.size()-1].id}]]*/ 0;

        const msgContainer = document.getElementById('chatMessages');
        const input = document.getElementById('chatInput');

        // â”€â”€ scroll to bottom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function scrollBottom(smooth) {
            msgContainer.scrollTo({ top: msgContainer.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
        }
        scrollBottom(false);

        // â”€â”€ render a single bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderBubble(msg) {
            const row = document.createElement('div');
            row.className = 'chat-bubble-row ' + (msg.own ? 'own' : 'other');

            let avatarHtml = '';
            if (!msg.own) {
                avatarHtml = `<div class="chat-bubble-avatar">${msg.sender.charAt(0).toUpperCase()}</div>`;
            }

            let bodyHtml;
            if (msg.content.startsWith('ğŸ“')) {
                const parts = msg.content.split('â†’ ');
                const link = parts[1] || '#';
                bodyHtml = `ğŸ“ Shared a location â†’ <a href="${link}" target="_blank" rel="noopener" class="chat-location-link">Open in Maps</a>`;
            } else {
                bodyHtml = escapeHtml(msg.content);
            }

            const senderLine = msg.own ? '' : `<div class="chat-bubble-sender">${escapeHtml(msg.sender)}</div>`;

            row.innerHTML = `
                ${avatarHtml}
                <div class="chat-bubble">
                    ${senderLine}
                    <span>${bodyHtml}</span>
                    <div class="chat-bubble-time">${msg.time}</div>
                </div>`;
            msgContainer.appendChild(row);
        }

        function escapeHtml(str) {
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // â”€â”€ send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            input.focus();
            await postMessage(text);
        }

        const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        async function postMessage(content) {
            try {
                const fd = new FormData();
                fd.append('content', content);
                const res = await fetch(`/chat/${REQUEST_ID}/send`, {
                    method: 'POST',
                    body: fd,
                    headers: { [CSRF_HEADER]: CSRF_TOKEN }
                });
                const msg = await res.json();
                if (msg.id) {
                    lastMsgId = msg.id;
                    renderBubble(msg);
                    scrollBottom(true);
                }
            } catch (e) { console.error(e); }
        }

        // â”€â”€ enter key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        // â”€â”€ mobile keyboard handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // When virtual keyboard opens/closes, adjust layout so input stays visible
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                const vh = window.visualViewport.height;
                document.querySelector('.chat-body').style.height = vh + 'px';
                scrollBottom(false);
            });
            window.visualViewport.addEventListener('scroll', () => {
                document.querySelector('.chat-inputbar').style.transform =
                    'translateY(' + (window.visualViewport.offsetTop * -1) + 'px)';
            });
        }
        // Focus input when tapping on it (ensure mobile gets focus)
        input.addEventListener('touchend', e => {
            e.preventDefault();
            input.focus();
        });

        // â”€â”€ poll new messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function poll() {
            try {
                const res = await fetch(`/chat/${REQUEST_ID}/messages?after=${lastMsgId}`);
                const msgs = await res.json();
                if (Array.isArray(msgs) && msgs.length > 0) {
                    const atBottom = msgContainer.scrollHeight - msgContainer.scrollTop - msgContainer.clientHeight < 60;
                    msgs.forEach(m => { lastMsgId = m.id; renderBubble(m); });
                    if (atBottom) scrollBottom(true);
                }
            } catch (e) { /* ignore */ }
        }
        setInterval(poll, 2000);

        // â”€â”€ location sharing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function shareLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            const btn = document.querySelector('.chat-loc-btn');
            btn.textContent = 'â³';
            btn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                pos => {
                    btn.textContent = 'ğŸ“'; btn.disabled = false;
                    const { latitude: lat, longitude: lng } = pos.coords;
                    const link = `https://www.google.com/maps?q=${lat},${lng}`;
                    postMessage(`ğŸ“ Shared a location â†’ ${link}`);
                },
                () => {
                    btn.textContent = 'ğŸ“'; btn.disabled = false;
                    alert('Could not get your location. Please allow location access.');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }
    </script>
</body>

</html>
